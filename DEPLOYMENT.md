# SnapMagic Deployment Guide

## Quick Deployment

### Prerequisites
- AWS CLI configured with appropriate permissions
- Node.js and npm installed
- Valid AWS temporary credentials

### One-Command Deployment

```bash
./deploy.sh
```

This script will:
1. ✅ Check AWS credentials
2. 📦 Install dependencies
3. 🔨 Build CDK project
4. 🏗️ Bootstrap CDK (if needed)
5. 🚀 Deploy infrastructure
6. 🔧 Configure Amplify automatically
7. 🌐 Show application URLs

### Manual Deployment Steps

If you prefer manual control:

1. **Set AWS Credentials**
   ```bash
   export AWS_ACCESS_KEY_ID=your_access_key
   export AWS_SECRET_ACCESS_KEY=your_secret_key
   export AWS_SESSION_TOKEN=your_session_token  # for temporary credentials
   ```

2. **Deploy Infrastructure**
   ```bash
   cd infrastructure
   npm install
   npm run build
   npx cdk bootstrap
   npx cdk deploy --require-approval never
   ```

3. **Configure Amplify** (use outputs from CDK deploy)
   ```bash
   # Step 1: Set environment variables
   aws amplify update-branch --app-id <APP_ID> --branch-name main --environment-variables SNAPMAGIC_API_URL=<API_URL>
   
   # Step 2: Trigger build
   aws amplify start-job --app-id <APP_ID> --branch-name main --job-type RELEASE
   ```

## Configuration

### Credentials
- Configured in `secrets.json`
- Default: `demo` / `demo`
- Automatically loaded by CDK and set as Lambda environment variables

### API URL
- Automatically generated by API Gateway
- Injected into Amplify build via environment variables
- Replaces `PLACEHOLDER_API_URL` in frontend during build

## Application URLs

After deployment:
- **API Gateway**: `https://<random-id>.execute-api.us-east-1.amazonaws.com/dev/`
- **Frontend**: `https://main.<amplify-domain>.amplifyapp.com`

## Login Credentials

- **Username**: `demo`
- **Password**: `demo`

## Troubleshooting

### Common Issues

1. **AWS Credentials Expired**
   ```bash
   aws sts get-caller-identity  # Check if credentials work
   ```

2. **CDK Bootstrap Required**
   ```bash
   npx cdk bootstrap
   ```

3. **Amplify Build Failed**
   - Check Amplify console for build logs
   - Verify environment variables are set
   - Manually trigger rebuild

4. **API URL Not Updated**
   - Check Amplify environment variables
   - Verify `PLACEHOLDER_API_URL` exists in frontend
   - Trigger new Amplify build

### Verification

1. **Backend API**
   ```bash
   curl -X POST "<API_URL>/api/login" \
     -H "Content-Type: application/json" \
     -d '{"username": "demo", "password": "demo"}'
   ```

2. **Frontend**
   - Open application URL in browser
   - Login with demo/demo
   - Try generating a trading card

## Architecture

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   GitHub Repo   │───▶│   AWS Amplify    │───▶│   Frontend      │
│                 │    │   (Build & Host) │    │   (Static Web)  │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   secrets.json  │───▶│   AWS CDK        │───▶│   API Gateway   │
│   (Config)      │    │   (Infrastructure│    │   + Lambda      │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

## Security

- Credentials stored in `secrets.json` (not in git)
- Environment variables injected at build/deploy time
- No hardcoded secrets in code
- JWT tokens for API authentication
